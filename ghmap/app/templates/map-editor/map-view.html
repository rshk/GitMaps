{% extends "map-editor/base.html" %}

{%block extra_head%}
<script type="text/javascript">
$(function(){
    // The GeoJSON layer URL
    var geojson_url = "{{ geojson_url }}";

    // The base layer
    // var tile_url = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png' // OSM
    // var tile_url = 'https://dnv9my2eseobd.cloudfront.net/v3/github.map-xgq2svrz/{z}/{x}/{y}.png' // OSM by GitHub
    var tile_url = "http://a.tiles.mapbox.com/v3/redshadow.map-9pbekffc/{z}/{x}/{y}.png"; // MapBox

    // To create new icons
    //---------------------
    // var icon = new L.Icon({
    //     iconUrl: 'https://dnv9my2eseobd.cloudfront.net/v3/marker/pin-s+438fd3.png',
    // });

    var initializeViewer = function(geojson_url, tile_url) {
        var map = L.map('map', {
            attributionControl: false,  // todo: move to the left instead..
        });

        var options = {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        }

        map.fitWorld();
        L.tileLayer(tile_url, options).addTo(map);

        $.ajax({
            method: 'GET',
            url: geojson_url,
            success: function(data) {
                L.geoJson(data, {
                    onEachFeature: function (feature, layer) {
                        var table_html = "<table class=\"table-striped table-bordered\"><tbody>", key, val;
                        for (key in feature.properties) {
                            val = feature.properties[key];
                            table_html += "<tr><th>" + key + "</th><td>"
                                + val + "</td></tr>";
                        }
                        table_html += "</tbody></table>";
                        layer.bindPopup(table_html);

                        // To change the icon:
                        //layer.setIcon(icon);
                    }
                }).addTo(map);
            }
        });
        return map;
    };


    var initializeEditor = function(geojson_url, tile_url) {
        var map = L.map('map', {
            attributionControl: false,  // todo: move to the left..
        });

        options = {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        }

        map.fitWorld();
        L.tileLayer(tile_url, options).addTo(map);


        var addEditingPopup = function(feature, layer) {
            var table_html = "<table class=\"table-striped table-bordered\"><tbody>", key, val;
            for (key in feature.properties) {
                val = feature.properties[key];
                table_html += "<tr><th>" + key + "</th><td>"
                    + "<input type='text' value='"+val+"'>"
                    + "</td></tr>";
            }
            table_html += "</tbody></table>";
            layer.bindPopup(table_html);
            // todo: on popup dismiss, we want to update the feature...
        };


        $.ajax({
            method: 'GET',
            url: geojson_url,
            success: function(data) {
                var layer = L.geoJson(data, {
                    onEachFeature: addEditingPopup
                });
                layer.addTo(map);

                window.layer = layer;

                //JSON.stringify(layer.toGeoJSON())

                // Initialize the FeatureGroup to store editable layers
                // var drawnItems = new L.FeatureGroup();
                // map.addLayer(drawnItems);
                var drawnItems = layer;

                // Initialize the draw control and pass it the FeatureGroup of editable layers
                var drawControl = new L.Control.Draw({
                    draw: {
                        polyline: false,
                        polygon: false,
                        rectangle: false,
                        circle: false
                    },

                    // edit: {featureGroup: layer}
                    edit: {featureGroup: drawnItems}
                });
                map.addControl(drawControl);

                // Keep edited things
                map.on('draw:created', function (e) {
                    var type = e.layerType,
                        layer = e.layer;
                    if (type === 'marker') {
                        //layer.bindPopup('A popup!');
                        addEditingPopup({properties:{ESSID:null,BSSID:null,Rating:null,Notes:null}}, layer);
                    }
                    drawnItems.addLayer(layer);
                });

            }
        });

        return map;

    };

    {% if mode == "view" %}
    window.map = initializeViewer(geojson_url, tile_url);
    {% elif mode == "edit" %}
    window.map = initializeEditor(geojson_url, tile_url);
    {% elif mode == "edit-raw" %}
    $('#map').html('Loading...');
    $.ajax({
        method: 'GET',
        url: geojson_url,
        success: function(data) {
            $('#map')
                .html('<button class="btn btn-success" type="button">Save GeoJSON map</button>')
                .append($('<textarea>').css({
                    position:'absolute',
                    top:'36px',left:0,right:0,bottom:0,
                    width:'auto'
                }).val(JSON.stringify(data, true, 2)));
        }
    });
    {% endif %}

});
</script>
{%endblock%}

{% block page_content %}

<div class="container-fluid" style="margin-top: 5px;">

    <ul class="nav nav-tabs">
        {% for key, label in [('view', 'View'), ('edit', 'Edit'), ('edit-raw', 'Raw')] %}
        <li{% if mode == key %} class="active"{% endif %}>
            <a href="?mode={{ key }}">{{ label }}</a>
        </li>
        {% endfor %}
    </ul>
</div>

    <div id="map"></div>
{%endblock%}

{%block footer%}{%endblock%}
